<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>canvasImg</title>
  <style>
    #toolbar {
      margin-bottom: 10px;
    }

    #mosaicCanvas {
      border: 1px solid black;
      cursor: crosshair;
    }

    .button {
      margin-right: 10px;
      padding: 5px 10px;
      cursor: pointer;
      background-color: lightgray;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .button.active {
      background-color: #4caf50;
      color: white;
    }
  </style>
</head>

<body>
  <div id="toolbar">
    <button class="button" id="enlargeBtn">放大</button>
    <button class="button" id="reduceBtn">缩小</button>
    <button class="button" id="drawArrowBtn">画箭头</button>
    <button class="button" id="mosaicBtn">马赛克</button>
    <button class="button" id="drawScribbleBtn">涂鸦</button>
    <button class="button" id="eraser">橡皮擦</button>
    <button class="button" id="textInputBtn">文本输入</button>
    <button class="button" id="rectBtn">矩形</button>
    <button class="button" id="circleBtn">圆</button>
    <button class="button" id="downloadBtn">下载</button>
    <button class="button" id="undoBtn">撤销</button>
    <button class="button" id="redoBtn">取消撤销</button>
    <button class="button" id="clearBtn">复原</button>

    <!-- 字体和颜色选择 -->
    <select id="fontSizeSelect">
      <option value="20">20px</option>
      <option value="24">24px</option>
      <option value="28">28px</option>
      <!-- Add more sizes as needed -->
    </select>

    <input type="color" id="fontColorPicker" value="#ff0000" />
    <input type="number" id="strokeWidth" value="4" />
  </div>
  <div class="" id="canvas-wrapper" style="width: 600px;height: 400px;">
    <canvas id="canvasId" width="600" height="400"></canvas>
  </div>

  <script type="module">

    import CanvasImgEditor from './canvasImgEditor.js'
    // import CanvasImgEditor from './index.esm.js'

    const canvasInstance = new CanvasImgEditor({
      parentId: 'canvas-wrapper',
      canvasId: 'canvasId',
      imgSrc: 'https://cdn.pixabay.com/photo/2024/01/02/10/33/stream-8482939_1280.jpg', // 替换为你要使用的图片路径
      currentTool: 'arrow', // 当前默认模式，默认为箭头
      currentWidth: 2, // 宽度，默认为2
      endPointWidth: 4, // 箭头、圆、矩形的端点宽度，默认为4
    })
    document.addEventListener('DOMContentLoaded', () => {
    // 工具按钮设置
    let currentTool = ''
    const enlargeBtn = document.getElementById('enlargeBtn');
    const reduceBtn = document.getElementById('reduceBtn');
    const arrowButton = document.getElementById('drawArrowBtn');
    const mosaicButton = document.getElementById('mosaicBtn');
    const scribbleButton = document.getElementById('drawScribbleBtn');
    const eraserButton = document.getElementById('eraser');
    const textInputButton = document.getElementById('textInputBtn');
    const rectButton = document.getElementById('rectBtn');
    const circleButton = document.getElementById('circleBtn');
    const undoButton = document.getElementById('undoBtn');
    const redoButton = document.getElementById('redoBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const clearBtn = document.getElementById('clearBtn');

    const colorNode = document.getElementById('fontColorPicker')
    const strokeWidthNode = document.getElementById('strokeWidth')
    const fontSizeNode = document.getElementById('fontSizeSelect')

    arrowButton.addEventListener('click', () => setTool('arrow'));
    mosaicButton.addEventListener('click', () => setTool('mosaic'));
    scribbleButton.addEventListener('click', () => setTool('scribble'));
    eraserButton.addEventListener('click', () => setTool('eraser'));
    textInputButton.addEventListener('click', () => setTool('text'));
    rectButton.addEventListener('click', () => setTool('rect'));
    circleButton.addEventListener('click', () => setTool('circle'));
    undoButton.addEventListener('click', undo);
    redoButton.addEventListener('click', redo);
    clearBtn.addEventListener('click', clear);
    downloadBtn.addEventListener('click', download);
    enlargeBtn.addEventListener('click', enlarge);
    reduceBtn.addEventListener('click', reduce);

    colorNode.addEventListener('change', changeColor)
    changeColor()

    strokeWidthNode.addEventListener('input', changeStrokeWidth)
    changeStrokeWidth()

    fontSizeNode.addEventListener('change', changeFontSize)
    changeFontSize()

    function setTool(tool) {
      currentTool = tool
      canvasInstance.setCurrentToolType(tool); // 设置当前操作类型
      console.log('currentTool', tool);
      arrowButton.classList.toggle('active', tool === 'arrow');
      mosaicButton.classList.toggle('active', tool === 'mosaic');
      scribbleButton.classList.toggle('active', tool === 'scribble');
      eraserButton.classList.toggle('active', tool === 'eraser');
      textInputButton.classList.toggle('active', tool === 'text');
      rectButton.classList.toggle('active', tool === 'rect');
      circleButton.classList.toggle('active', tool === 'circle');
    }

    function undo() {
      canvasInstance.undo()
    }
    function redo() {
      canvasInstance.redo()
    }
    function clear() {
      canvasInstance.clear()
    }
    function download() {
      const fileName = '这是自定义的文件名'
      const isBlob = true // 是否返回blob
      canvasInstance.download(false).then(res => {
        console.log(`${isBlob ? '返回结果': '已下载'}`, res)
      })
    }
    function changeColor() {
      const colorValue = colorNode.value
      console.log(`颜色值变化为：${colorValue}`)
      canvasInstance.changeColor(colorValue)
    }
    function changeStrokeWidth() {
      const value = strokeWidthNode.value
      if(currentTool === 'text') {
        console.log(`字体宽度变化为：${value}`)
        canvasInstance.setTextFontWight(value)
      } else {
        console.log(`strokeWidth变化为：${value}`)
        canvasInstance.changeStrokeWidth(value)
      }
     
    }
    function changeFontSize() {
      const value = fontSizeNode.value
      console.log(`FontSize变化为：${value}`)
      canvasInstance.setTextFontSize(value)
    }
    function enlarge() {
      setTool('scale')
      canvasInstance.scale();
    }
    function reduce() {
      setTool('scale')
      canvasInstance.scale(false);
    }
    // 事件注册
    canvasInstance.registerCallback({
      checkUndo: (canUndo) => {
        console.log('当前是否允许撤销', canUndo)
      },
      checkRedo: (canRedo) => {
        console.log('当前是否允许取消撤销', canRedo)
      },
    })
  })
  </script>
</body>

</html>